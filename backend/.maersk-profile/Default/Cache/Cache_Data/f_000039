import{ah as R,ai as S,ak as x,aj as E}from"./index-DXxT_osv.js";import{o as C,$ as M,h as L,f as U,E as _}from"./url-D0mrCgj2.js";class D{static async next(e,a){const{middleware:s,platformHeader:r,realmPath:o,serverConfig:c,tree:p,type:h}=R.get(a),m=a?a.query:{},g=this.constructUrl(c,o,p,m),u=S({url:new URL(g),init:this.configureRequest(e)},{type:e?E.Authenticate:E.StartAuthenticate,payload:{tree:p,type:h||"service"}})(s);r&&(u.init.headers instanceof Headers?u.init.headers.set("X-Requested-Platform",C):Array.isArray(u.init.headers)?u.init.headers.push(["X-Requested-Platform",C]):u.init.headers?u.init.headers["X-Requested-Platform"]=C:u.init.headers={"X-Requested-Platform":C});const y=await x(fetch(u.url.toString(),u.init),c.timeout);return await this.getResponseJson(y)}static constructUrl(e,a,s,r){const o={...r,...s?{authIndexType:"service",authIndexValue:s}:void 0},c=Object.keys(o).length>0?`?${M(o)}`:"",p=L("authenticate",a,e.paths);return U(e.baseUrl,`${p}${c}`)}static configureRequest(e){return{body:e?JSON.stringify(e):void 0,credentials:"include",headers:new Headers({Accept:"application/json","Accept-API-Version":"protocol=1.0,resource=2.1","Content-Type":"application/json","X-Requested-With":_}),method:"POST"}}static async getResponseJson(e){const a=e.headers.get("content-type"),s=a&&a.indexOf("application/json")>-1?await e.json():{};return s.status=e.status,s.ok=e.ok,s}}var i=(t=>(t.BooleanAttributeInputCallback="BooleanAttributeInputCallback",t.ChoiceCallback="ChoiceCallback",t.ConfirmationCallback="ConfirmationCallback",t.DeviceProfileCallback="DeviceProfileCallback",t.HiddenValueCallback="HiddenValueCallback",t.KbaCreateCallback="KbaCreateCallback",t.MetadataCallback="MetadataCallback",t.NameCallback="NameCallback",t.NumberAttributeInputCallback="NumberAttributeInputCallback",t.PasswordCallback="PasswordCallback",t.PingOneProtectEvaluationCallback="PingOneProtectEvaluationCallback",t.PingOneProtectInitializeCallback="PingOneProtectInitializeCallback",t.PollingWaitCallback="PollingWaitCallback",t.ReCaptchaCallback="ReCaptchaCallback",t.ReCaptchaEnterpriseCallback="ReCaptchaEnterpriseCallback",t.RedirectCallback="RedirectCallback",t.SelectIdPCallback="SelectIdPCallback",t.StringAttributeInputCallback="StringAttributeInputCallback",t.SuspendedTextOutputCallback="SuspendedTextOutputCallback",t.TermsAndConditionsCallback="TermsAndConditionsCallback",t.TextInputCallback="TextInputCallback",t.TextOutputCallback="TextOutputCallback",t.ValidatedCreatePasswordCallback="ValidatedCreatePasswordCallback",t.ValidatedCreateUsernameCallback="ValidatedCreateUsernameCallback",t))(i||{}),n=(t=>(t.CannotContainCharacters="CANNOT_CONTAIN_CHARACTERS",t.CannotContainDuplicates="CANNOT_CONTAIN_DUPLICATES",t.CannotContainOthers="CANNOT_CONTAIN_OTHERS",t.LeastCapitalLetters="AT_LEAST_X_CAPITAL_LETTERS",t.LeastNumbers="AT_LEAST_X_NUMBERS",t.MatchRegexp="MATCH_REGEXP",t.MaximumLength="MAX_LENGTH",t.MaximumNumber="MAXIMUM_NUMBER_VALUE",t.MinimumLength="MIN_LENGTH",t.MinimumNumber="MINIMUM_NUMBER_VALUE",t.Required="REQUIRED",t.Unique="UNIQUE",t.UnknownPolicy="UNKNOWN_POLICY",t.ValidArrayItems="VALID_ARRAY_ITEMS",t.ValidDate="VALID_DATE",t.ValidEmailAddress="VALID_EMAIL_ADDRESS_FORMAT",t.ValidNameFormat="VALID_NAME_FORMAT",t.ValidNumber="VALID_NUMBER",t.ValidPhoneFormat="VALID_PHONE_FORMAT",t.ValidQueryFilter="VALID_QUERY_FILTER",t.ValidType="VALID_TYPE",t))(n||{});function b(t,e,a){return t===1?e:a!==void 0?a:e+"s"}function d(t,e,a){return!t||t[e]===void 0?a:t[e]}const V={[n.CannotContainCharacters]:(t,e)=>{const a=d(e,"forbiddenChars","");return`${t} must not contain following characters: "${a}"`},[n.CannotContainDuplicates]:(t,e)=>{const a=d(e,"duplicateValue","");return`${t}  must not contain duplicates: "${a}"`},[n.CannotContainOthers]:(t,e)=>{const a=d(e,"disallowedFields","");return`${t} must not contain: "${a}"`},[n.LeastCapitalLetters]:(t,e)=>{const a=d(e,"numCaps",0);return`${t} must contain at least ${a} capital ${b(a,"letter")}`},[n.LeastNumbers]:(t,e)=>{const a=d(e,"numNums",0);return`${t} must contain at least ${a} numeric ${b(a,"value")}`},[n.MatchRegexp]:t=>`${t} has failed the "MATCH_REGEXP" policy`,[n.MaximumLength]:(t,e)=>{const a=d(e,"maxLength",0);return`${t} must be at most ${a} ${b(a,"character")}`},[n.MaximumNumber]:t=>`${t} has failed the "MAXIMUM_NUMBER_VALUE" policy`,[n.MinimumLength]:(t,e)=>{const a=d(e,"minLength",0);return`${t} must be at least ${a} ${b(a,"character")}`},[n.MinimumNumber]:t=>`${t} has failed the "MINIMUM_NUMBER_VALUE" policy`,[n.Required]:t=>`${t} is required`,[n.Unique]:t=>`${t} must be unique`,[n.UnknownPolicy]:(t,e)=>{const a=d(e,"policyRequirement","Unknown");return`${t}: Unknown policy requirement "${a}"`},[n.ValidArrayItems]:t=>`${t} has failed the "VALID_ARRAY_ITEMS" policy`,[n.ValidDate]:t=>`${t} has an invalid date`,[n.ValidEmailAddress]:t=>`${t} has an invalid email address`,[n.ValidNameFormat]:t=>`${t} has an invalid name format`,[n.ValidNumber]:t=>`${t} has an invalid number`,[n.ValidPhoneFormat]:t=>`${t} has an invalid phone number`,[n.ValidQueryFilter]:t=>`${t} has failed the "VALID_QUERY_FILTER" policy`,[n.ValidType]:t=>`${t} has failed the "VALID_TYPE" policy`};class q{static parseErrors(e,a){const s=[];return e.detail&&e.detail.failedPolicyRequirements&&e.detail.failedPolicyRequirements.map(r=>{s.push.apply(s,[{detail:r,messages:this.parseFailedPolicyRequirement(r,a)}])}),s}static parseFailedPolicyRequirement(e,a){const s=[];return e.policyRequirements.map(r=>{s.push(this.parsePolicyRequirement(e.property,r,a))}),s}static parsePolicyRequirement(e,a,s={}){const r=typeof a=="string"?JSON.parse(a):{...a},o=r.policyRequirement,c=s[o]||V[o]||V[n.UnknownPolicy],p=r.params?{...r.params,policyRequirement:o}:{policyRequirement:o};return c(e,p)}}var N=(t=>(t.LoginFailure="LoginFailure",t.LoginSuccess="LoginSuccess",t.Step="Step",t))(N||{});let F=class{constructor(e){this.payload=e,this.type=N.LoginFailure}getCode(){return Number(this.payload.code)}getDetail(){return this.payload.detail}getMessage(){return this.payload.message}getProcessedMessage(e){return q.parseErrors(this.payload,e)}getReason(){return this.payload.reason}},H=class{constructor(e){this.payload=e,this.type=N.LoginSuccess}getRealm(){return this.payload.realm}getSessionToken(){return this.payload.tokenId}getSuccessUrl(){return this.payload.successUrl}},l=class{constructor(e){this.payload=e}getType(){return this.payload.type}getInputValue(e=0){return this.getArrayElement(this.payload.input,e).value}setInputValue(e,a=0){this.getArrayElement(this.payload.input,a).value=e}getOutputValue(e=0){return this.getArrayElement(this.payload.output,e).value}getOutputByName(e,a){const s=this.payload.output.find(r=>r.name===e);return s?s.value:a}getArrayElement(e,a=0){if(e===void 0)throw new Error(`No NameValue array was provided to search (selector ${a})`);if(typeof a=="number"){if(a<0||a>e.length-1)throw new Error(`Selector index ${a} is out of range`);return e[a]}if(typeof a=="string"){const s=e.find(r=>r.name===a);if(!s)throw new Error(`Missing callback input entry "${a}"`);return s}if(typeof a=="object"&&a.test&&a.exec){const s=e.find(r=>a.test(r.name));if(!s)throw new Error(`Missing callback input entry "${a}"`);return s}throw new Error("Invalid selector value type")}},O=class extends l{constructor(e){super(e),this.payload=e}getName(){return this.getOutputByName("name","")}getPrompt(){return this.getOutputByName("prompt","")}isRequired(){return this.getOutputByName("required",!1)}getFailedPolicies(){const e=this.getOutputByName("failedPolicies",[]);try{return e.map(a=>JSON.parse(a))}catch{throw new Error('Unable to parse "failed policies" from the ForgeRock server. The JSON within `AttributeInputCallback` was either malformed or missing.')}}getPolicies(){return this.getOutputByName("policies",{})}setValidateOnly(e){this.setInputValue(e,/validateOnly/)}setValue(e){this.setInputValue(e)}};class K extends l{constructor(e){super(e),this.payload=e}getPrompt(){return this.getOutputByName("prompt","")}getDefaultChoice(){return this.getOutputByName("defaultChoice",0)}getChoices(){return this.getOutputByName("choices",[])}setChoiceIndex(e){const a=this.getChoices().length;if(e<0||e>a-1)throw new Error(`${e} is out of bounds`);this.setInputValue(e)}setChoiceValue(e){const a=this.getChoices().indexOf(e);if(a===-1)throw new Error(`"${e}" is not a valid choice`);this.setInputValue(a)}}let J=class extends l{constructor(e){super(e),this.payload=e}getDefaultOption(){return Number(this.getOutputByName("defaultOption",0))}getMessageType(){return Number(this.getOutputByName("messageType",0))}getOptions(){return this.getOutputByName("options",[])}getOptionType(){return Number(this.getOutputByName("optionType",0))}getPrompt(){return this.getOutputByName("prompt","")}setOptionIndex(e){if(e!==0&&e!==1)throw new Error(`"${e}" is not a valid choice`);this.setInputValue(e)}setOptionValue(e){const a=this.getOptions().indexOf(e);if(a===-1)throw new Error(`"${e}" is not a valid choice`);this.setInputValue(a)}},X=class extends l{constructor(e){super(e),this.payload=e}getMessage(){return this.getOutputByName("message","")}isMetadataRequired(){return this.getOutputByName("metadata",!1)}isLocationRequired(){return this.getOutputByName("location",!1)}setProfile(e){this.setInputValue(JSON.stringify(e))}};class Q extends l{constructor(e){super(e),this.payload=e}}let j=class extends l{constructor(e){super(e),this.payload=e}getPrompt(){return this.getOutputByName("prompt","")}getPredefinedQuestions(){return this.getOutputByName("predefinedQuestions",[])}isAllowedUserDefinedQuestions(){return this.getOutputByName("allowUserDefinedQuestions",!1)}setQuestion(e){this.setValue("question",e)}setAnswer(e){this.setValue("answer",e)}setValue(e,a){if(!this.payload.input)throw new Error("KBA payload is missing input");const s=this.payload.input.find(r=>r.name.endsWith(e));if(!s)throw new Error(`No input has name ending in "${e}"`);s.value=a}},W=class extends l{constructor(e){super(e),this.payload=e}getData(){return this.getOutputByName("data",{})}},Y=class extends l{constructor(e){super(e),this.payload=e}getPrompt(){return this.getOutputByName("prompt","")}setName(e){this.setInputValue(e)}},z=class extends l{constructor(e){super(e),this.payload=e}getFailedPolicies(){return this.getOutputByName("failedPolicies",[])}getPolicies(){return this.getOutputByName("policies",[])}getPrompt(){return this.getOutputByName("prompt","")}setPassword(e){this.setInputValue(e)}},G=class extends l{constructor(e){super(e),this.payload=e}getPauseBehavioralData(){return this.getOutputByName("pauseBehavioralData",!1)}setData(e){this.setInputValue(e,/signals/)}setClientError(e){this.setInputValue(e,/clientError/)}},Z=class extends l{constructor(e){super(e),this.payload=e}getConfig(){const e=this.getOutputByName("agentIdentification",void 0),a=this.getOutputByName("agentTimeout",void 0),s=this.getOutputByName("agentPort",void 0);return{envId:this.getOutputByName("envId",""),...e!==void 0?{agentIdentification:e}:{},...a!==void 0?{agentTimeout:a}:{},...s!==void 0?{agentPort:s}:{},behavioralDataCollection:this.getOutputByName("behavioralDataCollection",!0),disableTags:this.getOutputByName("disableTags",!1),universalDeviceIdentification:this.getOutputByName("universalDeviceIdentification",!1),consoleLogEnabled:this.getOutputByName("consoleLogEnabled",!1),deviceAttributesToIgnore:this.getOutputByName("deviceAttributesToIgnore",[]),customHost:this.getOutputByName("customHost",""),lazyMetadata:this.getOutputByName("lazyMetadata",!1),deviceKeyRsyncIntervals:this.getOutputByName("deviceKeyRsyncIntervals",14),enableTrust:this.getOutputByName("enableTrust",!1),disableHub:this.getOutputByName("disableHub",!1)}}setClientError(e){this.setInputValue(e,/clientError/)}},ee=class extends l{constructor(e){super(e),this.payload=e}getMessage(){return this.getOutputByName("message","")}getWaitTime(){return Number(this.getOutputByName("waitTime",0))}},te=class extends l{constructor(e){super(e),this.payload=e}getSiteKey(){return this.getOutputByName("recaptchaSiteKey","")}setResult(e){this.setInputValue(e)}},ae=class extends l{constructor(e){super(e),this.payload=e}getSiteKey(){return this.getOutputByName("recaptchaSiteKey","")}getApiUrl(){return this.getOutputByName("captchaApiUri","")}getElementClass(){return this.getOutputByName("captchaDivClass","")}setResult(e){this.setInputValue(e)}setClientError(e){this.setInputValue(e,"IDToken1clientError")}setPayload(e){this.setInputValue(e,"IDToken1payload")}setAction(e){this.setInputValue(e,"IDToken1action")}};class se extends l{constructor(e){super(e),this.payload=e}getRedirectUrl(){return this.getOutputByName("redirectUrl","")}}class re extends l{constructor(e){super(e),this.payload=e}getProviders(){return this.getOutputByName("providers",[])}setProvider(e){const a=this.getProviders().find(s=>s.provider===e);if(!a)throw new Error(`"${e}" is not a valid choice`);this.setInputValue(a.provider)}}class T extends l{constructor(e){super(e),this.payload=e}getMessage(){return this.getOutputByName("message","")}getMessageType(){return this.getOutputByName("messageType","")}}let ie=class extends T{constructor(e){super(e),this.payload=e}};class ne extends l{constructor(e){super(e),this.payload=e}getTerms(){return this.getOutputByName("terms","")}getVersion(){return this.getOutputByName("version","")}getCreateDate(){const e=this.getOutputByName("createDate","");return new Date(e)}setAccepted(e=!0){this.setInputValue(e)}}class le extends l{constructor(e){super(e),this.payload=e}getPrompt(){return this.getOutputByName("prompt","")}setInput(e){this.setInputValue(e)}}let ue=class extends l{constructor(e){super(e),this.payload=e}getFailedPolicies(){const e=this.getOutputByName("failedPolicies",[]);try{return e.map(a=>JSON.parse(a))}catch{throw new Error('Unable to parse "failed policies" from the ForgeRock server. The JSON within `ValidatedCreatePasswordCallback` was either malformed or missing.')}}getPolicies(){return this.getOutputByName("policies",{})}getPrompt(){return this.getOutputByName("prompt","")}isRequired(){return this.getOutputByName("required",!1)}setPassword(e){this.setInputValue(e)}setValidateOnly(e){this.setInputValue(e,/validateOnly/)}};class oe extends l{constructor(e){super(e),this.payload=e}getPrompt(){return this.getOutputByName("prompt","")}getFailedPolicies(){const e=this.getOutputByName("failedPolicies",[]);try{return e.map(a=>JSON.parse(a))}catch{throw new Error('Unable to parse "failed policies" from the ForgeRock server. The JSON within `ValidatedCreateUsernameCallback` was either malformed or missing.')}}getPolicies(){return this.getOutputByName("policies",{})}isRequired(){return this.getOutputByName("required",!1)}setName(e){this.setInputValue(e)}setValidateOnly(e){this.setInputValue(e,/validateOnly/)}}function v(t){switch(t.type){case i.BooleanAttributeInputCallback:return new O(t);case i.ChoiceCallback:return new K(t);case i.ConfirmationCallback:return new J(t);case i.DeviceProfileCallback:return new X(t);case i.HiddenValueCallback:return new Q(t);case i.KbaCreateCallback:return new j(t);case i.MetadataCallback:return new W(t);case i.NameCallback:return new Y(t);case i.NumberAttributeInputCallback:return new O(t);case i.PasswordCallback:return new z(t);case i.PingOneProtectEvaluationCallback:return new G(t);case i.PingOneProtectInitializeCallback:return new Z(t);case i.PollingWaitCallback:return new ee(t);case i.ReCaptchaCallback:return new te(t);case i.ReCaptchaEnterpriseCallback:return new ae(t);case i.RedirectCallback:return new se(t);case i.SelectIdPCallback:return new re(t);case i.StringAttributeInputCallback:return new O(t);case i.SuspendedTextOutputCallback:return new ie(t);case i.TermsAndConditionsCallback:return new ne(t);case i.TextInputCallback:return new le(t);case i.TextOutputCallback:return new T(t);case i.ValidatedCreatePasswordCallback:return new ue(t);case i.ValidatedCreateUsernameCallback:return new oe(t);default:return new l(t)}}class ce{constructor(e,a){this.payload=e,this.type=N.Step,this.callbacks=[],e.callbacks&&(this.callbacks=this.convertCallbacks(e.callbacks,a))}getCallbackOfType(e){const a=this.getCallbacksOfType(e);if(a.length!==1)throw new Error(`Expected 1 callback of type "${e}", but found ${a.length}`);return a[0]}getCallbacksOfType(e){return this.callbacks.filter(a=>a.getType()===e)}setCallbackValue(e,a){const s=this.getCallbacksOfType(e);if(s.length!==1)throw new Error(`Expected 1 callback of type "${e}", but found ${s.length}`);s[0].setInputValue(a)}getDescription(){return this.payload.description}getHeader(){return this.payload.header}getStage(){return this.payload.stage}convertCallbacks(e,a){return e.map(s=>(a||v)(s)||v(s))}}class ${static get previousStepKey(){return`${R.get().prefix}-PreviousStep`}static async next(e,a){const s=await D.next(e?e.payload:void 0,a);if(s.authId){const r=a?a.callbackFactory:void 0;return new ce(s,r)}return!s.authId&&s.ok?new H(s):new F(s)}static redirect(e){const a=e.getCallbackOfType(i.RedirectCallback).getRedirectUrl();localStorage.setItem(this.previousStepKey,JSON.stringify(e)),location.assign(a)}static async resume(e,a){const s=new URL(e),r=s.searchParams.get("code"),o=s.searchParams.get("error"),c=s.searchParams.get("errorCode"),p=s.searchParams.get("errorMessage"),h=s.searchParams.get("form_post_entry"),m=s.searchParams.get("nonce"),g=s.searchParams.get("RelayState"),u=s.searchParams.get("responsekey"),y=s.searchParams.get("scope"),f=s.searchParams.get("state"),k=s.searchParams.get("suspendedId"),I=s.searchParams.get("authIndexValue")??void 0;let w;function B(){return r&&f||h||u}if(B()){const P=localStorage.getItem(this.previousStepKey);if(!P)throw new Error("Error: could not retrieve original redirect information.");try{w=JSON.parse(P)}catch{throw new Error("Error: could not parse redirect params or step information")}localStorage.removeItem(this.previousStepKey)}const A={...a,query:{...r&&{code:r},...o&&{error:o},...c&&{errorCode:c},...p&&{errorMessage:p},...h&&{form_post_entry:h},...m&&{nonce:m},...g&&{RelayState:g},...u&&{responsekey:u},...y&&{scope:y},...f&&{state:f},...k&&{suspendedId:k},...a&&a.query},...((a==null?void 0:a.tree)??I)&&{tree:(a==null?void 0:a.tree)??I}};return await this.next(w,A)}static async start(e){return await $.next(void 0,e)}}export{$ as f,ce as i,i as l,N as r};
